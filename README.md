# Bed Data Connector

เนเธเธฃเน€เธเธเธ•เนเธเธตเนเนเธงเนเนเธเธเนเธซเนเนเธ•เนเธฅเธฐเนเธฃเธเธเธขเธฒเธเธฒเธฅเนเธเธฃเธฑเธเนเธเน€เธเธฃเธทเนเธญเธเธ•เธฑเธงเน€เธญเธ เน€เธเธทเนเธญ:

1. query เธเนเธญเธกเธนเธฅเน€เธ•เธตเธขเธ/เธเธนเนเธเนเธงเธขเธเธฒเธ HIS เธเธญเธเธ•เธฑเธงเน€เธญเธ
2. เธชเนเธเน€เธเนเธฒ API เธเธฅเธฒเธ `POST /api/receive` เธ•เธฒเธกเธฃเธญเธเน€เธงเธฅเธฒ

## 1) เธ•เธดเธ”เธ•เธฑเนเธ

```bash
npm install
```

## 2) เธ•เธฑเนเธเธเนเธฒ

เธเธฑเธ”เธฅเธญเธ `.env.example` เน€เธเนเธ `.env` เนเธฅเนเธงเนเธเนเธเนเธฒเธเธฃเธดเธ

เธเนเธฒเธ—เธตเนเธชเธณเธเธฑเธ:

- `API_RECEIVE_URL`: URL เธเธฅเธฒเธขเธ—เธฒเธ เน€เธเนเธ `http://your-api:3000/api/receive`
- `HCODE`: เธฃเธซเธฑเธชเนเธฃเธเธเธขเธฒเธเธฒเธฅ
- `HCODE_TOKEN`: token เธเธญเธเนเธฃเธเธเธขเธฒเธเธฒเธฅเธเธฑเนเธ
- `LATITUDE`, `LONGITUDE`: เธเธดเธเธฑเธ”เนเธฃเธเธเธขเธฒเธเธฒเธฅ (optional)
- `HIS_NAME`: เธเธทเนเธญเธฃเธฐเธเธ HIS (เน€เธเนเธ `HOSxP`, `JHCIS`)
- `HIS_DB_TYPE`: เธเธฃเธฐเน€เธ เธ—เธเธฒเธเธเนเธญเธกเธนเธฅ (`mysql`, `mariadb`, เธซเธฃเธทเธญ `postgres`)
- `HIS_PROFILE`: เนเธเธฃเนเธเธฅเน query เธเธญเธ HIS (`hosxp_v3` เธซเธฃเธทเธญ `hosxp_v4`) เธ–เนเธฒเนเธกเนเธเธณเธซเธเธ”เธเธฐ default เน€เธเนเธ `hosxp_v3` (เธซเธฃเธทเธญเน€เธ”เธฒเน€เธเนเธ `hosxp_v4` เน€เธกเธทเนเธญ `HIS_NAME` เธกเธต `v4`)
- `HIS_DB_*`: เธเธฒเธฃเน€เธเธทเนเธญเธกเธเธฒเธเธเนเธญเธกเธนเธฅ HIS เนเธฃเธเธเธขเธฒเธเธฒเธฅ
- query เธญเธขเธนเนเธ—เธตเนเนเธเธฅเน `src/his-query.ts`

## 3) เธฃเธนเธเนเธเธ SQL เธ—เธตเนเธ•เนเธญเธเนเธ”เน

เนเธเธฅเน `src/his-query.ts` เธ•เนเธญเธเธเธทเธเธเธญเธฅเธฑเธกเธเนเน€เธซเธฅเนเธฒเธเธตเน:

- `ward_id`
- `ward_name`
- `bed_actual`
- `patient_actual`

เธ•เธฑเธงเธญเธขเนเธฒเธ:

```sql
SELECT
  ward_code AS ward_id,
  ward_name,
  bed_actual,
  patient_actual
FROM his_bed_view
WHERE is_active = 1
```

## 4) เธฃเธฑเธ

เธฃเธฑเธเธ•เนเธญเน€เธเธทเนเธญเธเธ•เธฒเธกเธฃเธญเธเน€เธงเธฅเธฒ (TypeScript runtime):

```bash
npm run start:dev
```

เธฃเธฑเธเธชเนเธเธเธฃเธฑเนเธเน€เธ”เธตเธขเธง:

```bash
npm run start:once
```

build เน€เธเนเธ JavaScript:

```bash
npm run build
npm start
```

## 5) เธเธคเธ•เธดเธเธฃเธฃเธกเธชเนเธเธเนเธญเธกเธนเธฅ

- interval เธเนเธฒเน€เธฃเธดเนเธกเธ•เนเธเธ—เธธเธ 30 เธเธฒเธ—เธต (`SEND_INTERVAL_MINUTES`) เนเธฅเธฐเธชเนเธเธ•เธฒเธกเน€เธเนเธกเธเธฒเธฌเธดเธเธฒ (เน€เธเนเธ `00/30`)
- เธกเธต retry เน€เธกเธทเนเธญเธชเนเธเนเธกเนเธเนเธฒเธ (`RETRY_COUNT`, `RETRY_DELAY_MS`)
- เธเธฑเธเธเธฒเธเธเนเธญเธ: เธ–เนเธฒเธฃเธญเธเธเนเธญเธเธขเธฑเธเนเธกเนเธเธ เธฃเธญเธเนเธซเธกเนเธเธฐ queue pending แล้วส่งทันทีเมื่อรอบปัจจุบันจบ

